---
phase: 03-progress-display
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/stores/app.js
  - frontend/src/lib/SyncStatus.svelte
autonomous: true

must_haves:
  truths:
    - "Frontend displays global progress percentage"
    - "Frontend displays transfer speed in MB/s"
    - "Frontend displays ETA (time remaining)"
    - "Frontend displays file count progress (X of Y files)"
  artifacts:
    - path: "frontend/src/stores/app.js"
      provides: "Updated progress store shape"
      contains: "progressData"
    - path: "frontend/src/lib/SyncStatus.svelte"
      provides: "Enhanced progress display UI"
      contains: "bytesPerSecond"
  key_links:
    - from: "frontend/src/lib/SyncStatus.svelte"
      to: "frontend/src/stores/app.js"
      via: "store subscription"
      pattern: "\\$progressData"
---

<objective>
Update the frontend to display comprehensive progress information including global percentage, speed, and ETA.

Purpose: Transform the current single-file progress display into a full aggregate progress view showing overall sync status, transfer speed, and time remaining.

Output:
- Updated `frontend/src/stores/app.js` with progress store updates
- Updated `frontend/src/lib/SyncStatus.svelte` with enhanced progress UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-progress-display/03-RESEARCH.md
@.planning/phases/03-progress-display/03-01-SUMMARY.md

# Source files to modify
@frontend/src/stores/app.js
@frontend/src/lib/SyncStatus.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update progress store with derived values</name>
  <files>frontend/src/stores/app.js</files>
  <action>
Modify `frontend/src/stores/app.js` to add derived stores for progress data:

1. Add derived store imports at the top:
```javascript
import { writable, derived } from 'svelte/store';
```

2. Replace the simple transferProgress store with a richer progressData store:
```javascript
// Replace:
// export const transferProgress = writable(null);

// With:
// Raw progress data from backend (AggregateProgress shape)
export const progressData = writable(null);

// Keep transferProgress as alias for backward compatibility
export const transferProgress = progressData;

// Derived: formatted speed string
export const formattedSpeed = derived(progressData, $p => {
    if (!$p || !$p.bytesPerSecond || $p.bytesPerSecond <= 0) return '';
    const speed = $p.bytesPerSecond;
    if (speed >= 1024 * 1024) {
        return `${(speed / (1024 * 1024)).toFixed(1)} MB/s`;
    } else if (speed >= 1024) {
        return `${(speed / 1024).toFixed(1)} KB/s`;
    }
    return `${Math.round(speed)} B/s`;
});

// Derived: formatted ETA string
export const formattedETA = derived(progressData, $p => {
    if (!$p || !$p.eta || $p.eta < 0) return '';
    const eta = $p.eta;
    if (eta < 60) {
        return `${eta}s remaining`;
    } else if (eta < 3600) {
        const mins = Math.floor(eta / 60);
        const secs = eta % 60;
        return `${mins}:${secs.toString().padStart(2, '0')} remaining`;
    } else {
        const hours = Math.floor(eta / 3600);
        const mins = Math.floor((eta % 3600) / 60);
        return `${hours}h ${mins}m remaining`;
    }
});

// Derived: file count string
export const fileCountProgress = derived(progressData, $p => {
    if (!$p || !$p.totalFiles) return '';
    return `${$p.completedFiles} of ${$p.totalFiles} files`;
});

// Derived: is syncing
export const isSyncing = derived(progressData, $p => {
    return $p?.status === 'syncing';
});

// Derived: overall percentage
export const overallPercentage = derived(progressData, $p => {
    return $p?.percentage ?? 0;
});

// Derived: active files list (for file progress list)
export const activeFiles = derived(progressData, $p => {
    return $p?.activeFiles ?? [];
});
```

This keeps backward compatibility (transferProgress alias) while adding new derived stores for the UI.
  </action>
  <verify>
Check syntax: `cd frontend && npm run check` (or just verify no JS errors)
Grep for new stores: `grep -n "formattedSpeed\|formattedETA\|fileCountProgress" frontend/src/stores/app.js`
  </verify>
  <done>
stores/app.js updated with:
- progressData store receiving AggregateProgress
- formattedSpeed derived store (auto-formats to KB/s or MB/s)
- formattedETA derived store (formats seconds to MM:SS or HH:MM)
- fileCountProgress derived store (X of Y files)
- Backward compatible transferProgress alias
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SyncStatus.svelte with enhanced progress UI</name>
  <files>frontend/src/lib/SyncStatus.svelte</files>
  <action>
Modify `frontend/src/lib/SyncStatus.svelte` to display comprehensive progress:

1. Update imports at the top of script section:
```javascript
import {
    syncStatus,
    progressData,
    formattedSpeed,
    formattedETA,
    fileCountProgress,
    overallPercentage,
    activeFiles,
    recentEvents,
    folderPairs,
    peers
} from '../stores/app.js';
```

2. Update the event listener (around line 31):
```javascript
EventsOn('sync:progress', (data) => {
    progressData.set(data);
});
```

3. Replace the existing progress-section (around lines 254-266) with enhanced version:
```svelte
{#if $progressData && ($syncStatus.status === 'syncing' || $overallPercentage > 0)}
    <div class="progress-section">
        <!-- Overall progress header -->
        <div class="progress-header">
            <span class="progress-title">Syncing Files</span>
            <span class="progress-meta">
                {#if $fileCountProgress}
                    <span class="file-count">{$fileCountProgress}</span>
                {/if}
            </span>
        </div>

        <!-- Global progress bar -->
        <div class="progress-info">
            <span class="progress-percentage">{Math.round($overallPercentage)}%</span>
            <span class="progress-stats">
                {#if $formattedSpeed}
                    <span class="speed">{$formattedSpeed}</span>
                {/if}
                {#if $formattedETA}
                    <span class="eta">{$formattedETA}</span>
                {/if}
            </span>
        </div>
        <div class="progress-bar global">
            <div class="progress-fill" style="width: {$overallPercentage}%"></div>
        </div>

        <!-- Active file (show first active file if any) -->
        {#if $activeFiles.length > 0}
            <div class="active-file">
                <span class="file-name">{$activeFiles[0].path}</span>
                <span class="file-progress">{Math.round($activeFiles[0].percentage)}%</span>
            </div>
            <div class="progress-bar file">
                <div class="progress-fill" style="width: {$activeFiles[0].percentage}%"></div>
            </div>
        {/if}
    </div>
{/if}
```

4. Update the reactive statement to use new store:
```javascript
// Remove old: $: progressPercentage = $transferProgress ? $transferProgress.percentage : 0;
// The reactive updates are now handled by derived stores
```

5. Add new CSS styles at the end of the style section:
```css
.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.progress-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #f1f5f9;
}

.progress-meta {
    font-size: 0.75rem;
    color: #94a3b8;
}

.file-count {
    background: rgba(59, 130, 246, 0.2);
    padding: 2px 8px;
    border-radius: 4px;
    color: #60a5fa;
}

.progress-percentage {
    font-size: 1.25rem;
    font-weight: 600;
    color: #f1f5f9;
}

.progress-stats {
    display: flex;
    gap: 12px;
    font-size: 0.8rem;
}

.speed {
    color: #4ade80;
    font-weight: 500;
}

.eta {
    color: #94a3b8;
}

.progress-bar.global {
    height: 8px;
    margin-bottom: 12px;
}

.progress-bar.file {
    height: 4px;
}

.active-file {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    font-size: 0.8rem;
}

.active-file .file-name {
    color: #94a3b8;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 70%;
}

.active-file .file-progress {
    color: #60a5fa;
    font-weight: 500;
}
```

Keep all existing CSS intact, just add these new styles.
  </action>
  <verify>
Open the app with `wails3 dev` and trigger a sync.
Verify:
- Global progress bar shows overall percentage
- Speed shows in MB/s or KB/s format
- ETA shows time remaining
- File count shows "X of Y files"
- Individual file progress appears below global bar
  </verify>
  <done>
SyncStatus.svelte updated with:
- Overall progress percentage (large, prominent)
- File count display (X of Y files)
- Transfer speed in MB/s or KB/s
- ETA showing time remaining
- Individual file progress for current file
- Clean, organized layout
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. No JavaScript errors: `cd frontend && npm run check` (if available)
2. Grep for new imports: `grep -n "formattedSpeed\|formattedETA" frontend/src/lib/SyncStatus.svelte`
3. Build app: `wails3 build` - should succeed
4. Manual test: Start app, trigger sync, observe:
   - Global % updates smoothly (not every chunk)
   - Speed shows and updates (e.g., "2.5 MB/s")
   - ETA appears after ~5% complete
   - File count shows progress
</verification>

<success_criteria>
- Stores updated with derived progress values
- SyncStatus.svelte displays global progress bar with percentage
- Speed displayed in human-readable format (MB/s)
- ETA displayed when available
- File count progress shown (X of Y files)
- Individual file progress visible
- No JavaScript errors
- App builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-progress-display/03-03-SUMMARY.md`
</output>
