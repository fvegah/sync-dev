---
phase: 04-native-macos-ui
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - frontend/src/stores/app.js
  - frontend/src/App.svelte
  - frontend/src/main.js
autonomous: true

must_haves:
  truths:
    - "User sees a Finder-style translucent sidebar"
    - "Navigation uses Lucide icons"
    - "Sidebar is draggable for window movement"
    - "Dark/light mode follows system preference"
  artifacts:
    - path: "frontend/src/stores/app.js"
      provides: "Svelte 5 compatible stores"
      contains: "writable"
    - path: "frontend/src/App.svelte"
      provides: "Main layout with macOS sidebar"
      contains: "backdrop-blur"
    - path: "frontend/src/main.js"
      provides: "Svelte 5 mount entry point"
      contains: "mount"
  key_links:
    - from: "frontend/src/App.svelte"
      to: "lucide-svelte"
      via: "Icon imports"
      pattern: "import.*from.*lucide-svelte"
    - from: "frontend/src/App.svelte"
      to: "frontend/src/stores/app.js"
      via: "Store subscriptions"
      pattern: "\\$currentTab"
---

<objective>
Migrate stores to Svelte 5 compatibility and redesign App.svelte with Finder-style sidebar

Purpose: Create the main application shell with macOS-native vibrancy effects and Lucide icons. The sidebar will be the primary navigation element.

Output:
- Stores compatible with Svelte 5 (existing stores work, but patterns reviewed)
- App.svelte with translucent sidebar, Lucide icons, and responsive layout
- main.js updated for Svelte 5 mount() API
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-native-macos-ui/04-RESEARCH.md
@.planning/phases/04-native-macos-ui/04-02-SUMMARY.md

@frontend/src/stores/app.js
@frontend/src/App.svelte
@frontend/src/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite stores with Svelte 5 runes patterns</name>
  <files>frontend/src/stores/app.js</files>
  <action>
This task MODIFIES the existing stores/app.js file. The existing stores use Svelte's `writable` and `derived` which remain compatible with Svelte 5, but we are rewriting the file to ensure consistent patterns and add any missing stores.

Rewrite frontend/src/stores/app.js with the following content:

```javascript
import { writable, derived } from 'svelte/store';

// Current tab - navigation state
export const currentTab = writable('peers');

// Peers list from backend
export const peers = writable([]);

// Folder pairs configuration
export const folderPairs = writable([]);

// Sync status from backend
export const syncStatus = writable({
    status: 'idle',
    action: ''
});

// Raw progress data from backend (AggregateProgress shape)
export const progressData = writable(null);

// Backward compatibility alias
export const transferProgress = progressData;

// Derived: formatted speed string
export const formattedSpeed = derived(progressData, ($p) => {
    if (!$p || !$p.bytesPerSecond || $p.bytesPerSecond <= 0) return '';
    const speed = $p.bytesPerSecond;
    if (speed >= 1024 * 1024) {
        return `${(speed / (1024 * 1024)).toFixed(1)} MB/s`;
    } else if (speed >= 1024) {
        return `${(speed / 1024).toFixed(1)} KB/s`;
    }
    return `${Math.round(speed)} B/s`;
});

// Derived: formatted ETA string
export const formattedETA = derived(progressData, ($p) => {
    if (!$p || !$p.eta || $p.eta < 0) return '';
    const eta = $p.eta;
    if (eta < 60) {
        return `${eta}s remaining`;
    } else if (eta < 3600) {
        const mins = Math.floor(eta / 60);
        const secs = eta % 60;
        return `${mins}:${secs.toString().padStart(2, '0')} remaining`;
    } else {
        const hours = Math.floor(eta / 3600);
        const mins = Math.floor((eta % 3600) / 60);
        return `${hours}h ${mins}m remaining`;
    }
});

// Derived: file count string
export const fileCountProgress = derived(progressData, ($p) => {
    if (!$p || !$p.totalFiles) return '';
    return `${$p.completedFiles} of ${$p.totalFiles} files`;
});

// Derived: is syncing
export const isSyncing = derived(progressData, ($p) => {
    return $p?.status === 'syncing';
});

// Derived: overall percentage
export const overallPercentage = derived(progressData, ($p) => {
    return $p?.percentage ?? 0;
});

// Derived: active files list
export const activeFiles = derived(progressData, ($p) => {
    return $p?.activeFiles ?? [];
});

// Recent sync events
export const recentEvents = writable([]);

// App config
export const config = writable({
    deviceId: '',
    deviceName: '',
    port: 52525,
    syncIntervalMins: 5,
    globalExclusions: [],
    autoSync: true,
    showNotifications: true
});

// Pairing state
export const pairingState = writable({
    code: '',
    isPairing: false,
    targetPeer: null
});

// Modal state
export const modalState = writable({
    show: false,
    type: null,
    data: null
});

// Helper to show modal
export function showModal(type, data = null) {
    modalState.set({ show: true, type, data });
}

// Helper to close modal
export function closeModal() {
    modalState.set({ show: false, type: null, data: null });
}
```

Note: Svelte stores work seamlessly with Svelte 5. The $ prefix subscription syntax works in both .svelte files and .js files. No changes needed to derived store patterns.
  </action>
  <verify>
File frontend/src/stores/app.js is valid JavaScript.
Import the stores in a test and verify no runtime errors.
  </verify>
  <done>
Stores are Svelte 5 compatible.
All derived stores use arrow function syntax consistently.
Export structure unchanged for backward compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Redesign App.svelte with Finder-style sidebar</name>
  <files>frontend/src/App.svelte</files>
  <action>
Rewrite frontend/src/App.svelte with:
- Svelte 5 runes ($state, $derived)
- Lucide icons for navigation
- Translucent sidebar with backdrop-blur
- macOS-style navigation items
- Responsive to light/dark mode

```svelte
<script>
    import { Monitor, Folder, RefreshCw, Settings } from 'lucide-svelte';
    import { currentTab, modalState, closeModal, pairingState } from './stores/app.js';
    import PeerList from './lib/PeerList.svelte';
    import FolderPairs from './lib/FolderPairs.svelte';
    import SyncStatus from './lib/SyncStatus.svelte';
    import SettingsComponent from './lib/Settings.svelte';
    import { RequestPairing } from '../wailsjs/go/main/App.js';

    let pairingInputCode = $state('');

    const tabs = [
        { id: 'peers', label: 'Devices', icon: Monitor },
        { id: 'folders', label: 'Folders', icon: Folder },
        { id: 'sync', label: 'Sync', icon: RefreshCw },
        { id: 'settings', label: 'Settings', icon: Settings }
    ];

    function setTab(tabId) {
        currentTab.set(tabId);
    }

    async function submitPairing() {
        if (!$modalState.data || !pairingInputCode) return;

        try {
            await RequestPairing($modalState.data.id, pairingInputCode);
            pairingState.set({ code: pairingInputCode, isPairing: true, targetPeer: $modalState.data });
            closeModal();
            pairingInputCode = '';
        } catch (err) {
            alert('Pairing failed: ' + err);
        }
    }

    function handleModalOverlayClick() {
        closeModal();
    }

    function handleModalContentClick(event) {
        event.stopPropagation();
    }
</script>

<main class="h-screen w-screen overflow-hidden bg-slate-900 dark:bg-slate-950 text-slate-100">
    <div class="flex h-full">
        <!-- Sidebar with macOS vibrancy -->
        <aside class="
            w-52 h-full flex flex-col
            bg-white/5 dark:bg-slate-900/30
            backdrop-blur-md backdrop-saturate-150
            border-r border-white/10 dark:border-slate-700/50
            pt-8
        " style="-webkit-app-region: drag;">
            <!-- App title -->
            <div class="flex items-center gap-3 px-5 mb-6" style="-webkit-app-region: no-drag;">
                <div class="w-8 h-8 flex items-center justify-center">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-7 h-7 text-macos-blue">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                </div>
                <span class="text-lg font-semibold">SyncDev</span>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-3" style="-webkit-app-region: no-drag;">
                {#each tabs as tab}
                    {@const Icon = tab.icon}
                    <button
                        class="
                            w-full flex items-center gap-3 px-3 py-2.5 mb-1 rounded-lg
                            text-sm font-medium transition-colors
                            {$currentTab === tab.id
                                ? 'bg-macos-blue/20 text-macos-blue'
                                : 'text-slate-400 hover:text-slate-100 hover:bg-white/5'
                            }
                        "
                        onclick={() => setTab(tab.id)}
                    >
                        <Icon size={18} strokeWidth={2} />
                        <span>{tab.label}</span>
                    </button>
                {/each}
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 dark:from-slate-900 dark:to-slate-950">
            {#if $currentTab === 'peers'}
                <PeerList />
            {:else if $currentTab === 'folders'}
                <FolderPairs />
            {:else if $currentTab === 'sync'}
                <SyncStatus />
            {:else if $currentTab === 'settings'}
                <SettingsComponent />
            {/if}
        </div>
    </div>

    <!-- Pairing Modal -->
    {#if $modalState.show && $modalState.type === 'pairing'}
        <div
            class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50"
            onclick={handleModalOverlayClick}
            role="dialog"
            aria-modal="true"
        >
            <div
                class="bg-slate-800 border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl"
                onclick={handleModalContentClick}
            >
                <h3 class="text-xl font-semibold mb-3">Pair with {$modalState.data?.name}</h3>
                <p class="text-slate-400 text-sm mb-4">Enter the 6-digit code shown on the other device:</p>
                <input
                    type="text"
                    maxlength="6"
                    bind:value={pairingInputCode}
                    placeholder="000000"
                    class="
                        w-full p-4 bg-black/30 border border-white/10 rounded-lg
                        text-2xl text-center font-mono tracking-[0.5em]
                        text-slate-100 placeholder-slate-600
                        focus:outline-none focus:border-macos-blue
                    "
                />
                <div class="flex justify-end gap-3 mt-6">
                    <button
                        class="px-4 py-2 text-sm font-medium text-slate-300 bg-white/10 border border-white/20 rounded-lg hover:bg-white/15 transition-colors"
                        onclick={closeModal}
                    >
                        Cancel
                    </button>
                    <button
                        class="px-4 py-2 text-sm font-medium text-white bg-macos-blue rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick={submitPairing}
                        disabled={pairingInputCode.length !== 6}
                    >
                        Pair
                    </button>
                </div>
            </div>
        </div>
    {/if}
</main>
```

Key changes from Svelte 3:
- `let pairingInputCode = $state('')` instead of `let pairingInputCode = ''`
- `onclick={fn}` instead of `on:click={fn}`
- `on:click|stopPropagation` replaced with explicit event handler
- Lucide icons imported and rendered as components with props
- All inline styles use Tailwind classes
- Removed all `<style>` block - Tailwind handles all styling
  </action>
  <verify>
File frontend/src/App.svelte exists with new content.
Contains: "$state(", "onclick=", "lucide-svelte", "backdrop-blur".
Does NOT contain: "on:click=", "<style>", "$:", "export let".
  </verify>
  <done>
App.svelte uses Svelte 5 runes.
Sidebar has translucent vibrancy effect.
Navigation uses Lucide icons.
Tailwind handles all styling with dark mode support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update main.js for Svelte 5 mount API</name>
  <files>frontend/src/main.js</files>
  <action>
Update frontend/src/main.js to use Svelte 5's mount() function:

```javascript
import './app.css';
import { mount } from 'svelte';
import App from './App.svelte';

const app = mount(App, {
    target: document.getElementById('app'),
});

export default app;
```

Note: Svelte 5 replaces `new Component()` with `mount(Component, { target })`. The return value is the component instance.
  </action>
  <verify>
File frontend/src/main.js contains "mount" and "svelte".
Run `npm run build` in frontend/ to verify no syntax errors.
  </verify>
  <done>
main.js uses Svelte 5 mount() API.
App CSS is imported before component mount.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds in frontend/
2. `npm run dev` starts and shows the sidebar
3. Sidebar is translucent with blur effect
4. Navigation icons are Lucide SVGs
5. Tab switching works (clicking nav items changes content area)
6. Dark mode applies when system is in dark mode
</verification>

<success_criteria>
- App.svelte uses Svelte 5 runes ($state)
- Sidebar has backdrop-blur-md vibrancy effect
- Lucide icons render for all nav items
- Navigation tab switching works
- No <style> block - all Tailwind utilities
- main.js uses mount() from svelte
</success_criteria>

<output>
After completion, create `.planning/phases/04-native-macos-ui/04-03-SUMMARY.md`
</output>
