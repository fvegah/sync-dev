---
phase: 02-menu-bar-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - main.go
  - app.go
  - internal/tray/tray.go
  - internal/tray/icons.go
  - internal/tray/icons/tray-idle.png
  - internal/tray/icons/tray-syncing.png
  - internal/tray/icons/tray-error.png
autonomous: true

must_haves:
  truths:
    - "System tray icon appears in macOS menu bar"
    - "App has no Dock icon (ActivationPolicyAccessory)"
    - "Context menu shows: Sync Now, Pause/Resume, Open SyncDev, Quit"
    - "Clicking tray icon toggles window visibility"
  artifacts:
    - path: "internal/tray/tray.go"
      provides: "System tray manager"
      contains: "SetMenu"
    - path: "internal/tray/icons.go"
      provides: "Embedded tray icons"
      contains: "//go:embed"
    - path: "internal/tray/icons/tray-idle.png"
      provides: "Idle state icon"
    - path: "main.go"
      provides: "Systray initialization"
      contains: "NewManager"
  key_links:
    - from: "main.go"
      to: "internal/tray/tray.go"
      via: "tray.NewManager()"
      pattern: "tray\\.NewManager"
    - from: "internal/tray/tray.go"
      to: "internal/tray/icons.go"
      via: "IconIdle"
      pattern: "IconIdle|IconSyncing|IconError"
---

<objective>
Implement system tray with context menu using Wails v3 native API.

Purpose: TRAY-01 (minimize to tray), TRAY-02 (context menu with actions)

Output:
- System tray icon in macOS menu bar
- App runs as accessory (no Dock icon)
- Context menu with Sync Now, Pause/Resume, Open, Quit
- Click tray to toggle window
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-menu-bar-integration/02-RESEARCH.md
@.planning/phases/02-menu-bar-integration/02-01-PLAN.md
@main.go
@app.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tray icon assets directly in internal/tray/icons/</name>
  <files>
    internal/tray/icons/tray-idle.png
    internal/tray/icons/tray-syncing.png
    internal/tray/icons/tray-error.png
  </files>
  <action>
Create template icons for macOS menu bar. Template icons must be:
- 22x22 pixels
- Black (#000000) with alpha transparency
- macOS will auto-invert to white in dark mode

1. Create the icons directory in final location:
   ```bash
   mkdir -p internal/tray/icons
   ```

2. Create simple 22x22 template icons using ImageMagick or Go program:

The icons should represent:
- tray-idle.png: Two circular arrows (sync complete)
- tray-syncing.png: Two arrows with motion indicator
- tray-error.png: Warning triangle or exclamation

If ImageMagick is available:
```bash
# Create simple placeholder icons
convert -size 22x22 xc:transparent -fill black -draw "circle 11,11 11,3" internal/tray/icons/tray-idle.png
convert -size 22x22 xc:transparent -fill black -draw "circle 11,11 11,5" internal/tray/icons/tray-syncing.png
convert -size 22x22 xc:transparent -fill black -draw "polygon 11,3 3,19 19,19" internal/tray/icons/tray-error.png
```

Alternatively, use the existing icon bytes from systray.go or create a Go program to generate PNG icons.
  </action>
  <verify>
    Run `ls -la internal/tray/icons/tray-*.png` - all 3 icons exist
    Run `file internal/tray/icons/tray-idle.png` - shows PNG image
  </verify>
  <done>
    - internal/tray/icons/ directory created
    - tray-idle.png exists (22x22 template)
    - tray-syncing.png exists
    - tray-error.png exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create internal/tray/icons.go</name>
  <files>
    internal/tray/icons.go
  </files>
  <action>
Create the icons package with embedded assets:

```go
package tray

import (
    _ "embed"
)

// Template icons for macOS menu bar
// These are black + transparent PNGs, 22x22 pixels
// macOS automatically adapts them for light/dark mode
// Icons created by Task 1 in internal/tray/icons/

//go:embed icons/tray-idle.png
var IconIdle []byte

//go:embed icons/tray-syncing.png
var IconSyncing []byte

//go:embed icons/tray-error.png
var IconError []byte
```
  </action>
  <verify>
    Run `ls internal/tray/icons/*.png` - icons in correct location
    Run `go build ./internal/tray/...` - compiles
  </verify>
  <done>
    - internal/tray/icons.go created
    - Icons embedded correctly
    - Package compiles
  </done>
</task>

<task type="auto">
  <name>Task 3: Create internal/tray/tray.go</name>
  <files>
    internal/tray/tray.go
  </files>
  <action>
Create the tray manager:

```go
package tray

import (
    "runtime"

    "github.com/wailsapp/wails/v3/pkg/application"
)

// State represents the current sync state for icon display
type State int

const (
    StateIdle State = iota
    StateSyncing
    StateError
)

// Manager manages the system tray icon and menu
type Manager struct {
    app       *application.App
    systray   *application.SystemTray
    window    *application.WebviewWindow
    pauseItem *application.MenuItem
    isPaused  bool
}

// SyncActions defines the interface for sync operations
type SyncActions interface {
    SyncNow()
    IsPaused() bool
    Pause()
    Resume()
}

// NewManager creates a new tray manager
func NewManager(app *application.App, window *application.WebviewWindow, actions SyncActions) *Manager {
    m := &Manager{
        app:    app,
        window: window,
    }

    // Create system tray
    m.systray = app.NewSystemTray()
    m.systray.SetTooltip("SyncDev - Folder Sync")

    // Set initial icon (idle state)
    if runtime.GOOS == "darwin" {
        m.systray.SetTemplateIcon(IconIdle)
    }

    // Create context menu
    menu := app.NewMenu()

    menu.Add("Sync Now").OnClick(func(ctx *application.Context) {
        go actions.SyncNow()
    })

    m.pauseItem = menu.Add("Pause Sync")
    m.pauseItem.OnClick(func(ctx *application.Context) {
        if m.isPaused {
            actions.Resume()
            m.isPaused = false
            m.pauseItem.SetLabel("Pause Sync")
        } else {
            actions.Pause()
            m.isPaused = true
            m.pauseItem.SetLabel("Resume Sync")
        }
    })

    menu.AddSeparator()

    menu.Add("Open SyncDev").OnClick(func(ctx *application.Context) {
        window.Show()
        window.Focus()
    })

    menu.AddSeparator()

    menu.Add("Quit").OnClick(func(ctx *application.Context) {
        app.Quit()
    })

    m.systray.SetMenu(menu)

    // Attach window for click-to-toggle behavior
    m.systray.AttachWindow(window).WindowOffset(5)

    return m
}

// SetState updates the tray icon based on sync state
func (m *Manager) SetState(state State) {
    if runtime.GOOS != "darwin" {
        return
    }

    var icon []byte
    switch state {
    case StateIdle:
        icon = IconIdle
    case StateSyncing:
        icon = IconSyncing
    case StateError:
        icon = IconError
    default:
        icon = IconIdle
    }
    m.systray.SetTemplateIcon(icon)
}
```
  </action>
  <verify>
    Run `go build ./internal/tray/...` - compiles
  </verify>
  <done>
    - internal/tray/tray.go created
    - Manager struct with NewManager constructor
    - SetState for icon updates
    - Context menu with all required items
    - Package compiles
  </done>
</task>

<task type="auto">
  <name>Task 4: Update app.go for tray integration (EXECUTE BEFORE Task 5)</name>
  <files>
    app.go
  </files>
  <action>
**Note:** Execute this task BEFORE Task 5 (main.go) because main.go depends on the updated startup signature.

Update app.go to:
1. Add tray manager reference
2. Implement SyncActions interface (IsPaused, Pause, Resume)
3. Update startup signature

```go
// Add import at top:
import "SyncDev/internal/tray"

// Update App struct:
type App struct {
    app          *application.App
    window       *application.WebviewWindow
    tray         *tray.Manager  // NEW
    configStore  *config.Store
    syncEngine   *sync.Engine
    pairingCode  string
    paused       bool  // NEW
}

// Update startup signature to receive tray:
func (a *App) startup(app *application.App, window *application.WebviewWindow, trayManager *tray.Manager) {
    a.app = app
    a.window = window
    a.tray = trayManager
    // ... rest of existing startup code ...
}

// Add SyncActions interface methods:

// IsPaused returns whether sync is paused
func (a *App) IsPaused() bool {
    return a.paused
}

// Pause pauses automatic sync
func (a *App) Pause() {
    a.paused = true
    if a.syncEngine != nil {
        a.syncEngine.UpdateAutoSync(false)
    }
}

// Resume resumes automatic sync
func (a *App) Resume() {
    a.paused = false
    if a.syncEngine != nil {
        a.syncEngine.UpdateAutoSync(a.configStore.Get().AutoSync)
    }
}
```
  </action>
  <verify>
    Run `go build ./...` - compiles (may have errors until Task 5 updates main.go)
    Run `grep "func.*startup.*trayManager" app.go` - new signature present
    Run `grep "IsPaused\|Pause\|Resume" app.go` - methods exist
  </verify>
  <done>
    - app.go has tray reference
    - IsPaused, Pause, Resume implemented
    - startup signature accepts trayManager
    - Build succeeds after Task 5
  </done>
</task>

<task type="auto">
  <name>Task 5: Update main.go to use tray manager</name>
  <files>
    main.go
  </files>
  <action>
**Note:** Execute this task AFTER Task 4 (app.go) because this calls the updated startup signature.

Update main.go to:
1. Set ActivationPolicyAccessory for no Dock icon
2. Initialize tray manager

```go
package main

import (
    "embed"
    "log"

    "SyncDev/internal/tray"

    "github.com/wailsapp/wails/v3/pkg/application"
    "github.com/wailsapp/wails/v3/pkg/events"
)

//go:embed all:frontend/dist
var assets embed.FS

func main() {
    appInstance := NewApp()

    app := application.New(application.Options{
        Name:        "SyncDev",
        Description: "Folder Sync for Mac",
        Assets: application.AssetOptions{
            FS: assets,
        },
        Mac: application.MacOptions{
            // KEY: Run as menu bar app, no Dock icon
            ActivationPolicy: application.ActivationPolicyAccessory,
        },
    })

    // Create main window (hidden by default for tray app)
    window := app.NewWebviewWindowWithOptions(application.WebviewWindowOptions{
        Title:       "SyncDev",
        Width:       1024,
        Height:      700,
        MinWidth:    800,
        MinHeight:   600,
        Hidden:      true,  // Start hidden
        Mac: application.MacWindow{
            TitleBar: application.MacTitleBar{
                AppearsTransparent: true,
                FullSizeContent:    true,
            },
            Appearance: application.NSAppearanceNameDarkAqua,
        },
    })

    // Hide instead of close
    window.RegisterHook(events.Common.WindowClosing, func(e *application.WindowEvent) {
        window.Hide()
        e.Cancel()
    })

    // Initialize tray manager
    trayManager := tray.NewManager(app, window, appInstance)

    // Bind app methods
    app.Bind(appInstance)

    // Initialize app
    appInstance.startup(app, window, trayManager)

    if err := app.Run(); err != nil {
        log.Fatal(err)
    }
}
```
  </action>
  <verify>
    Run `go build ./...` - compiles
  </verify>
  <done>
    - main.go imports internal/tray
    - ActivationPolicyAccessory set
    - Window starts Hidden
    - tray.NewManager() called
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 6: Verify systray functionality</name>
  <files>
    main.go
    internal/tray/tray.go
  </files>
  <action>
1. Build and verify:
   ```bash
   go build ./...
   ```

2. Verify all required patterns exist:
   ```bash
   grep "ActivationPolicyAccessory" main.go
   grep "NewSystemTray" internal/tray/tray.go
   grep "SetMenu" internal/tray/tray.go
   grep "AttachWindow" internal/tray/tray.go
   ```

3. Run tests:
   ```bash
   go test ./...
   ```
  </action>
  <verify>
    All grep commands return matches
    Build succeeds
    Tests pass
  </verify>
  <done>
    - ActivationPolicyAccessory configured
    - SystemTray created with menu
    - Window attached for click behavior
    - All tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds:
   ```bash
   go build ./...
   ```

2. Tray package compiles:
   ```bash
   go build ./internal/tray/...
   ```

3. Icons exist:
   ```bash
   ls internal/tray/icons/*.png
   ```

4. Key patterns present:
   ```bash
   grep "ActivationPolicyAccessory" main.go
   grep "NewManager" main.go
   grep "SetMenu" internal/tray/tray.go
   ```
</verification>

<success_criteria>
- [ ] build/icons/ or internal/tray/icons/ has 3 PNG icons
- [ ] internal/tray/icons.go embeds all 3 icons
- [ ] internal/tray/tray.go implements Manager with menu
- [ ] main.go sets ActivationPolicyAccessory
- [ ] main.go creates tray.NewManager()
- [ ] app.go implements IsPaused, Pause, Resume
- [ ] `go build ./...` succeeds
- [ ] `go test ./...` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-menu-bar-integration/02-02-SUMMARY.md`
</output>
