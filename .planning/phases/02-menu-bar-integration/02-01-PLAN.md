---
phase: 02-menu-bar-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - main.go
  - go.mod
  - app.go
autonomous: true

must_haves:
  truths:
    - "Application uses Wails v3 instead of v2"
    - "Window hides instead of closing when user clicks X"
    - "App continues running after window is hidden"
    - "All existing frontend bindings still work"
  artifacts:
    - path: "main.go"
      provides: "Wails v3 application entry point"
      contains: "github.com/wailsapp/wails/v3/pkg/application"
    - path: "go.mod"
      provides: "Wails v3 dependency"
      contains: "wails/v3"
  key_links:
    - from: "main.go"
      to: "app.go"
      via: "app.Bind()"
      pattern: "Bind\\(.*\\)"
    - from: "main.go"
      to: "frontend/dist"
      via: "embed directive"
      pattern: "//go:embed all:frontend/dist"
---

<objective>
Migrate from Wails v2 to Wails v3 to enable native system tray support.

Purpose: Wails v2 cannot support system tray due to main thread conflicts with fyne.io/systray. Wails v3 provides native systray API.

Output:
- Application runs on Wails v3
- Window hides on close instead of quitting
- All existing functionality preserved
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-menu-bar-integration/02-RESEARCH.md
@main.go
@app.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update go.mod for Wails v3</name>
  <files>
    go.mod
  </files>
  <action>
1. Update go.mod to use Wails v3:
   ```bash
   go get github.com/wailsapp/wails/v3@latest
   ```

2. Remove Wails v2 dependency if still present:
   ```bash
   go mod edit -droprequire github.com/wailsapp/wails/v2
   ```

3. Run go mod tidy to clean up:
   ```bash
   go mod tidy
   ```

4. Verify go.mod contains wails/v3:
   ```bash
   grep "wails/v3" go.mod
   ```
  </action>
  <verify>
    Run `grep "wails/v3" go.mod` - should show v3 dependency
    Run `go mod tidy` - no errors
  </verify>
  <done>
    - go.mod updated to Wails v3
    - No v2 dependency remaining
    - go mod tidy succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite main.go for Wails v3 API</name>
  <files>
    main.go
  </files>
  <action>
Rewrite main.go to use Wails v3 procedural API. Key changes:

1. Update imports from v2 to v3:
   ```go
   import (
       "embed"
       "log"

       "github.com/wailsapp/wails/v3/pkg/application"
       "github.com/wailsapp/wails/v3/pkg/events"
   )
   ```

2. Replace `wails.Run(&options.App{...})` with v3 pattern:
   ```go
   func main() {
       appInstance := NewApp()

       app := application.New(application.Options{
           Name:        "SyncDev",
           Description: "Folder Sync for Mac",
           Assets: application.AssetOptions{
               FS: assets,
           },
           Mac: application.MacOptions{
               // ActivationPolicyAccessory will be added in Plan 02-02
               // For now, keep as regular app
           },
       })

       // Create main window
       window := app.NewWebviewWindowWithOptions(application.WebviewWindowOptions{
           Title:       "SyncDev",
           Width:       1024,
           Height:      700,
           MinWidth:    800,
           MinHeight:   600,
           Mac: application.MacWindow{
               TitleBar: application.MacTitleBar{
                   AppearsTransparent: true,
                   FullSizeContent:    true,
               },
               Appearance: application.NSAppearanceNameDarkAqua,
           },
       })

       // Hide instead of close - KEY for tray behavior
       window.RegisterHook(events.Common.WindowClosing, func(e *application.WindowEvent) {
           window.Hide()
           e.Cancel()
       })

       // Bind app methods
       app.Bind(appInstance)

       // OnStartup equivalent
       appInstance.startup(app, window)

       if err := app.Run(); err != nil {
           log.Fatal(err)
       }
   }
   ```

3. Keep the `//go:embed all:frontend/dist` directive unchanged.

4. Delete systray-related commented code (will be reimplemented in Plan 02-02).
  </action>
  <verify>
    Run `go build ./...` - compiles without errors
    Run `grep "application.New" main.go` - v3 API in use
    Run `grep "RegisterHook" main.go` - hide-on-close hook present
    Run `grep "WindowClosing" main.go` - event type used
  </verify>
  <done>
    - main.go uses Wails v3 API
    - Window RegisterHook for hide-on-close
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Update app.go for Wails v3 runtime</name>
  <files>
    app.go
  </files>
  <action>
Update app.go to use Wails v3 runtime patterns:

1. Update import from v2 to v3:
   ```go
   // Remove:
   // "github.com/wailsapp/wails/v2/pkg/runtime"

   // Add:
   "github.com/wailsapp/wails/v3/pkg/application"
   ```

2. Add app and window reference to App struct:
   ```go
   type App struct {
       app          *application.App             // NEW
       window       *application.WebviewWindow   // NEW
       configStore  *config.Store
       syncEngine   *sync.Engine
       pairingCode  string
   }
   ```

3. Update startup signature:
   ```go
   func (a *App) startup(app *application.App, window *application.WebviewWindow) {
       a.app = app
       a.window = window
       // ... rest unchanged
   }
   ```

4. Update event emission in callbacks:
   ```go
   // v3 pattern - emit via app events
   engine.SetStatusCallback(func(status sync.SyncStatus, action string) {
       a.app.Events.Emit(&application.WailsEvent{
           Name: "sync:status",
           Data: map[string]interface{}{
               "status": status,
               "action": action,
           },
       })
   })
   ```

5. Update window manipulation methods:
   ```go
   // MinimizeToTray - v3 pattern
   func (a *App) MinimizeToTray() {
       a.window.Hide()
   }

   // ShowWindow - v3 pattern
   func (a *App) ShowWindow() {
       a.window.Show()
       a.window.Focus()
   }

   // QuitApp - v3 pattern
   func (a *App) QuitApp() {
       a.app.Quit()
   }
   ```

6. Update SelectFolder dialog:
   ```go
   func (a *App) SelectFolder() (string, error) {
       homeDir, _ := os.UserHomeDir()
       result, err := application.OpenDirectoryDialog(application.OpenDialogOptions{
           Title:            "Select Folder to Sync",
           DefaultDirectory: homeDir,
       })
       // ...
   }
   ```

7. Remove the `ctx context.Context` field since v3 doesn't use context pattern the same way.
  </action>
  <verify>
    Run `go build ./...` - compiles without errors
  </verify>
  <done>
    - app.go uses Wails v3 runtime
    - Window reference stored for hide/show
    - Event emission updated
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 4: Delete obsolete systray.go</name>
  <files>
    systray.go
  </files>
  <action>
Delete the existing systray.go file since it uses fyne.io/systray which is incompatible:

```bash
rm systray.go
```

System tray will be reimplemented using Wails v3 native API in Plan 02-02.

Also remove fyne.io/systray from go.mod if present:
```bash
go mod edit -droprequire fyne.io/systray
go mod tidy
```
  </action>
  <verify>
    Run `ls systray.go 2>/dev/null` - should show file not found
    Run `go build ./...` - compiles without errors
  </verify>
  <done>
    - systray.go deleted
    - fyne.io/systray dependency removed
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 5: Verify full application works</name>
  <files>
    main.go
    app.go
  </files>
  <action>
1. Build the application:
   ```bash
   go build ./...
   ```

2. Check that all existing tests still pass:
   ```bash
   go test ./...
   ```

3. Verify imports are correct:
   ```bash
   grep -r "wails/v2" *.go internal/**/*.go 2>/dev/null
   # Should return nothing - all v2 references removed
   ```

4. Verify v3 is used:
   ```bash
   grep -r "wails/v3" main.go app.go
   # Should show v3 imports
   ```
  </action>
  <verify>
    Run `go build ./...` - compiles successfully
    Run `go test ./...` - all tests pass
    Run `grep -r "wails/v2" *.go` - no v2 references
  </verify>
  <done>
    - Application compiles with Wails v3
    - All tests pass
    - No Wails v2 references remain
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds:
   ```bash
   go build ./...
   ```

2. Tests pass:
   ```bash
   go test ./...
   ```

3. Wails v3 in use:
   ```bash
   grep "wails/v3" go.mod
   ```

4. Hide on close implemented:
   ```bash
   grep "WindowClosing" main.go
   grep "Cancel()" main.go
   ```

5. No v2 references:
   ```bash
   grep -r "wails/v2" *.go 2>/dev/null
   # Should return empty
   ```
</verification>

<success_criteria>
- [ ] go.mod contains Wails v3 dependency
- [ ] main.go uses `application.New()` pattern
- [ ] Window RegisterHook for WindowClosing implemented
- [ ] app.go updated for v3 runtime
- [ ] systray.go deleted
- [ ] `go build ./...` succeeds
- [ ] `go test ./...` passes
- [ ] No Wails v2 references remain
</success_criteria>

<output>
After completion, create `.planning/phases/02-menu-bar-integration/02-01-SUMMARY.md`
</output>
